{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apprendre les Salutations en Ewondo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
        .section { margin-bottom: 30px; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1); }
        .exercise { margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 8px; }
        .hidden { display: none; }
        .btn-audio { background: none; border: none; cursor: pointer; font-size: 1.2em; }
        .feedback { margin-top: 10px; font-weight: bold; }
        .correct { color: green; }
        .incorrect { color: red; }
        .btn-back { background-color: #FFB300; color: white; border: none; padding: 10px 20px; border-radius: 5px; text-decoration: none; display: inline-block; margin-bottom: 20px; }
        .btn-back:hover { background-color: #e69a00; }
        .word-block { display: inline-block; padding: 10px; margin: 5px; background: #007bff; color: white; border-radius: 5px; cursor: pointer; }
        .word-block.selected { background: #28a745; }
        .selected-container { margin-top: 20px; padding: 10px; background: #d1ecf1; border-radius: 8px; min-height: 50px; display: flex; flex-wrap: wrap; }
        
    </style>
</head>
<body>

<div class="container mt-4">
    <a href="{% url 'detail' cours.slug %}" class="btn-back">‚¨Ö Retour √† la liste des cours</a>
    <div class="section text-center">
        <h2 class="text-primary">üìñ Introduction : Les Salutations en Ewondo</h2>
        <p>Apprenez √† saluer et √† engager une conversation simple en Ewondo.</p>
       
        {% if lecon.image_lecon %}
            <img src="{{ lecon.image_lecon.url }}" width="200" class="mx-5">
        {% endif %}
    </div>
    <!-- Introduction -->
    <section class="section">
        <h2 class="text-primary">1. Introduction</h2>
        <p>{{lecon.intro}}</p>
    </section>

   <!-- Vocabulaire de Base -->
<section class="section">
    <h2 class="text-primary">2. Vocabulaire de Base</h2>
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>Fran√ßais</th>
                <th>Ewondo</th>
                <th>Prononciation</th>
                <th>Utilisation</th>
                <th>Audio</th>
            </tr>
        </thead>
        <tbody>
            {% for mot in vocabulaire %}
            <tr>
                <td>{{ mot.fran√ßais }}</td>
                <td>{{ mot.langue }}</td>
                <td>{{ mot.prononciation }}</td>
                <td>{{ mot.utilisation }}</td>
                <td>
                    {% if mot.audio %}
                    <audio controls>
                        <source src="{{ mot.audio.url }}" type="audio/mpeg">
                        Votre navigateur ne supporte pas l'√©l√©ment audio.
                    </audio>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<!-- Exemples de Dialogues -->
<section class="section">
    <h2 class="text-primary">3. Exemples de Dialogues</h2>
    {% for dialogue in dialogues %}
    <h4>{{ dialogue.titre }}</h4>
    <div class="border p-3 bg-light">
        {% for ligne in dialogue.lignes.all %}
        <p>
            <strong>{{ ligne.personnage }} :</strong> {{ ligne.texte }}
            {% if ligne.audio %}
            <audio controls class="btn-audio float-end">
                <source src="{{ ligne.audio.url }}" type="audio/mpeg">
                Votre navigateur ne supporte pas l'√©l√©ment audio.
            </audio>
            {% endif %}
        </p>
        {% endfor %}
    </div>
    <p class="mt-2">{{ dialogue.description }}</p>
    {% endfor %}
</section>

<!-- Exercices Pratiques -->
<section class="section">
    <h2 class="text-primary">4. Exercices Pratiques</h2>
    {% for exercice in exercices %}
    <div class="exercise">
        <p><strong>{{ exercice.type }} :</strong> {{ exercice.question }}</p>
        {% if exercice.type == 'traduction' %}
            <!-- Input pour la traduction et bouton de validation -->
            <input type="text" class="form-control" id="ex{{ exercice.id }}_input" placeholder="Votre r√©ponse...">
            <button class="btn btn-primary mt-2" onclick="validateExercice({{ exercice.id }}, '{{ exercice.r√©ponse }}')">Valider</button>
        {% elif exercice.type == 'quiz' %}
            <!-- Exemple : plusieurs options propos√©es -->
            <button class="btn btn-light" onclick="selectOption({{ exercice.id }}, 'Option 1', '{{ exercice.r√©ponse }}')">Option 1</button>
            <button class="btn btn-light" onclick="selectOption({{ exercice.id }}, 'Option 2', '{{ exercice.r√©ponse }}')">Option 2</button>
            <button class="btn btn-light" onclick="selectOption({{ exercice.id }}, 'Option 3', '{{ exercice.r√©ponse }}')">Option 3</button>
            <!-- Bouton de validation pour le quiz -->
            <button class="btn btn-primary mt-2" onclick="validateExerciceQuiz({{ exercice.id }}, '{{ exercice.r√©ponse }}')">Valider</button>
        {% endif %}        
        <p id="feedback-{{ exercice.id }}" class="feedback"></p>
    </div>
    {% endfor %}
</section>

<!-- Jeux -->
<section class="section">
    <h2 class="text-primary">5. Jeux</h2>
    {% for jeu in jeux %}
    <div class="exercise">
        <p><strong>{{ jeu.type }} :</strong> {{ jeu.instructions }}</p>

        <!-- Afficher le contenu en fonction du type de jeu -->
        {% if jeu.type == 'reconstitution' %}
            <p>S√©lectionnez les mots dans le bon ordre :</p>
    
            <!-- Conteneur pour les mots m√©lang√©s -->
            <div id="word-container-{{ jeu.id }}" class="word-container">
                {% for mot in jeu.donn√©es.motsM√©lang√©s %}
                    <span class="word-block" onclick="selectWord('{{ jeu.id }}', this, '{{ mot }}')">{{ mot }}</span>
                {% endfor %}
            </div>

            <!-- Conteneur pour les mots s√©lectionn√©s -->
            <div id="selected-container-{{ jeu.id }}" class="selected-container"></div>

            <button class="btn btn-success" onclick="validateSentence('{{ jeu.id }}', {{ jeu.donn√©es.phraseCorrecte|safe }})">Valider</button>
            <p id="feedback-{{ jeu.id }}" class="feedback"></p>
    
        {% elif jeu.type == 'quiz' %}
            <p>{{ jeu.donn√©es.question }}</p>
            {% for option in jeu.donn√©es.options %}
                <button class="btn btn-light" onclick="checkQuiz(this, '{{ option }}', '{{ jeu.donn√©es.r√©ponse_correcte }}', '{{ jeu.id }}')">{{ option }}</button>
            {% endfor %}
            <p id="quiz-feedback-{{ jeu.id }}" class="feedback"></p>

        {% elif jeu.type == 'association' %}
            <div id="association-container-{{ jeu.id }}" class="mb-3">
                {% for paire in jeu.donn√©es.paires %}
                    <div class="word-block" onclick="selectWord('{{ paire.fran√ßais }}', '{{ jeu.id }}')">{{ paire.fran√ßais }}</div>
                    <div class="word-block" onclick="selectWord('{{ paire.ewondo }}', '{{ jeu.id }}')">{{ paire.ewondo }}</div>
                {% endfor %}
            </div>
            <button class="btn btn-success" onclick="validateAssociation('{{ jeu.id }}', {{ jeu.donn√©es.paires|safe }})">Valider</button>
            <p id="association-feedback-{{ jeu.id }}" class="feedback"></p>

        {% elif jeu.type == 'traduction' %}
            <p>Traduisez : {{ jeu.donn√©es.phrase }}</p>
            <input type="text" id="traduction-input-{{ jeu.id }}" class="form-control" placeholder="Votre r√©ponse...">
            <button class="btn btn-success" onclick="validateTraduction('{{ jeu.id }}', '{{ jeu.donn√©es.r√©ponse_correcte }}')">Valider</button>
            <p id="traduction-feedback-{{ jeu.id }}" class="feedback"></p>

        {% elif jeu.type == 'compl√©tion' %}
            <div class="dialogue" id="dialogue-{{ jeu.id }}">
                {% for ligne in jeu.donn√©es.dialogue %}
                    <p>
                        <strong>{{ ligne.personnage }} :</strong>
                        {% for mot in ligne.texte.split %}
                            {% if mot == "__________" %}
                                <input type="text" class="form-control" placeholder="Votre r√©ponse..." 
                                    style="width: auto; display: inline-block; text-align: center;">
                            {% else %}
                                {{ mot }}
                            {% endif %}
                        {% endfor %}
                    </p>
                {% endfor %}
            </div>
            <button class="btn btn-success" onclick="validateCompl√©tion('{{ jeu.id }}', {{ jeu.donn√©es.r√©ponses_correctes|safe }})">Valider</button>
            <p id="compl√©tion-feedback-{{ jeu.id }}" class="feedback"></p>
        {% endif %}

    </div>
    {% endfor %}
</section>

    <button class="btn btn-success mt-3" onclick="terminerLecon()">Terminer la le√ßon</button>
</div>


<script>
    //traduction ok
    function validateExercice(exerciceId, correctAnswer) {
        let input = document.getElementById("ex" + exerciceId + "_input");
        let feedback = document.getElementById("feedback-" + exerciceId);
        let userAnswer = input.value.toLowerCase().trim();
        if (userAnswer === correctAnswer.toLowerCase().trim()) {
            feedback.textContent = "‚úÖ Bonne r√©ponse !";
            feedback.className = "feedback correct";
        } else {
            feedback.textContent = "‚ùå Mauvaise r√©ponse. Essayez encore !";
            feedback.className = "feedback incorrect";
        }
    }
</script>

<script>
    //quiz
    function checkQuiz(button, option, r√©ponse_correcte, jeuId) {
        const feedback = document.getElementById(`quiz-feedback-${jeuId}`);
        if (option === r√©ponse_correcte) {
            feedback.textContent = "‚úÖ Bonne r√©ponse !";
            feedback.className = "feedback correct";
        } else {
            feedback.textContent = "‚ùå Mauvaise r√©ponse. Essayez encore !";
            feedback.className = "feedback incorrect";
        }
    }

    //association
    function validateAssociation(jeuId, paires) {
        const selectedPairs = []; // R√©cup√©rer les paires s√©lectionn√©es
        const feedback = document.getElementById(`association-feedback-${jeuId}`);
    
        if (JSON.stringify(selectedPairs) === JSON.stringify(paires)) {
            feedback.textContent = "Bravo ! Vous avez correctement associ√© les mots.";
            feedback.className = "feedback correct";
        } else {
            feedback.textContent = "Incorrect. Essayez encore !";
            feedback.className = "feedback incorrect";
        }
    }

    //dialogue
    function validateCompl√©tion(jeuId, r√©ponsesCorrectes) {
        const r√©ponses = []; // R√©cup√©rer les r√©ponses de l'utilisateur
        const feedback = document.getElementById(`compl√©tion-feedback-${jeuId}`);
    
        if (JSON.stringify(r√©ponses) === JSON.stringify(r√©ponsesCorrectes)) {
            feedback.textContent = "Bravo ! Vous avez correctement compl√©t√© le dialogue.";
            feedback.className = "feedback correct";
        } else {
            feedback.textContent = "Incorrect. Essayez encore !";
            feedback.className = "feedback incorrect";
        }
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("[id^='word-container-']").forEach(container => {
            const jeuId = container.id.split('-')[2]; // Extraire l'ID du jeu
            const motsMelanges = JSON.parse(container.getAttribute("data-mots")); // R√©cup√©rer les mots m√©lang√©s
            
            console.log(`Jeu ${jeuId} - Mots m√©lang√©s :`, motsMelanges); // V√©rification console
            
            if (motsMelanges.length > 0) {
                generateWordBlocks(jeuId, motsMelanges);
            }
        });
    });

    function generateWordBlocks(jeuId, motsMelanges) {
        const wordContainer = document.getElementById(`word-container-${jeuId}`);
        wordContainer.innerHTML = ""; // Nettoyer le conteneur au cas o√π

        // Conteneur pour afficher les mots s√©lectionn√©s
        const selectedContainer = document.createElement("div");
        selectedContainer.id = `selected-container-${jeuId}`;
        selectedContainer.className = "selected-container mb-2";
        wordContainer.parentNode.insertBefore(selectedContainer, wordContainer);

        window.selectedWords = window.selectedWords || {};
        window.selectedWords[jeuId] = [];

        motsMelanges.forEach(word => {
            let block = document.createElement("span");
            block.textContent = word;
            block.classList.add("word-block");
            block.onclick = function () { selectWord(jeuId, this, word); };
            wordContainer.appendChild(block);
        });

        console.log(`Blocs de mots affich√©s pour le jeu ${jeuId}`);
    }

    function selectWord(jeuId, block, word) {
        if (!window.selectedWords[jeuId].includes(word)) {
            window.selectedWords[jeuId].push(word);
            block.classList.add("selected");
            block.onclick = null;

            let selectedContainer = document.getElementById(`selected-container-${jeuId}`);
            let selectedBlock = document.createElement("span");
            selectedBlock.textContent = word;
            selectedBlock.classList.add("word-block");
            selectedContainer.appendChild(selectedBlock);
        }
    }

    function validateSentence(jeuId, phraseCorrecte) {
        const feedback = document.getElementById(`feedback-${jeuId}`);
        let selectedSentence = window.selectedWords[jeuId];

        if (JSON.stringify(selectedSentence) === JSON.stringify(phraseCorrecte)) {
            feedback.textContent = "‚úÖ Bravo ! Vous avez correctement reconstitu√© la phrase.";
            feedback.className = "feedback correct";
        } else {
            feedback.textContent = "‚ùå Incorrect. Essayez encore !";
            feedback.className = "feedback incorrect";
        }

        console.log(`Validation pour jeu ${jeuId}:`, selectedSentence, "==", phraseCorrecte);
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let selectedWords = {}; // Stocke les mots s√©lectionn√©s par jeu
    
        function selectWord(jeuId, element, word) {
            if (!selectedWords[jeuId]) {
                selectedWords[jeuId] = [];
            }
    
            let selectedContainer = document.getElementById(`selected-container-${jeuId}`);
            let wordContainer = document.getElementById(`word-container-${jeuId}`);
    
            // V√©rifier si le mot est d√©j√† s√©lectionn√©
            let wordIndex = selectedWords[jeuId].indexOf(word);
            if (wordIndex === -1) { 
                // **S√©lectionner le mot**
                selectedWords[jeuId].push(word);
                element.classList.add("selected");
                element.onclick = null; // D√©sactiver le clic sur cet √©l√©ment
    
                // Ajouter au conteneur des mots s√©lectionn√©s
                let selectedBlock = document.createElement("span");
                selectedBlock.textContent = word;
                selectedBlock.classList.add("word-block", "selected-block");
                selectedBlock.onclick = function () {
                    deselectWord(jeuId, this, word);
                };
                selectedContainer.appendChild(selectedBlock);
            }
        }
    
        function deselectWord(jeuId, element, word) {
            let wordContainer = document.getElementById(`word-container-${jeuId}`);
    
            // Retirer le mot de la liste s√©lectionn√©e
            selectedWords[jeuId] = selectedWords[jeuId].filter(m => m !== word);
            element.remove(); // Supprimer du conteneur s√©lectionn√©
    
            // Remettre le mot dans le conteneur des mots m√©lang√©s
            let wordBlock = document.createElement("span");
            wordBlock.textContent = word;
            wordBlock.classList.add("word-block");
            wordBlock.onclick = function () {
                selectWord(jeuId, this, word);
            };
            wordContainer.appendChild(wordBlock);
        }
    
        function validateSentence(jeuId, phraseCorrecte) {
            const feedback = document.getElementById(`feedback-${jeuId}`);
            let selectedSentence = selectedWords[jeuId] || [];
    
            console.log(`Validation pour jeu ${jeuId}:`, selectedSentence, "==", phraseCorrecte);
    
            if (JSON.stringify(selectedSentence) === JSON.stringify(phraseCorrecte)) {
                feedback.textContent = "‚úÖ Bravo ! Vous avez correctement reconstitu√© la phrase.";
                feedback.className = "feedback correct";
            } else {
                feedback.textContent = "‚ùå Incorrect. Essayez encore !";
                feedback.className = "feedback incorrect";
            }
        }
    
        // Rendre les fonctions accessibles globalement
        window.selectWord = selectWord;
        window.deselectWord = deselectWord;
        window.validateSentence = validateSentence;
    });
    
</script>

<script>
    function validateCompl√©tion(jeuId, r√©ponsesCorrectes) {
        const inputs = document.querySelectorAll(`#dialogue-${jeuId} input`);
        let toutesCorrectes = true;
    
        inputs.forEach((input, index) => {
            const r√©ponseUtilisateur = input.value.trim().toLowerCase();
            const r√©ponseCorrecte = r√©ponsesCorrectes[index].toLowerCase();
    
            if (r√©ponseUtilisateur === r√©ponseCorrecte) {
                input.style.borderColor = "green"; // Bonne r√©ponse
            } else {
                input.style.borderColor = "red"; // Mauvaise r√©ponse
                toutesCorrectes = false;
    
                // Afficher la bonne r√©ponse apr√®s validation
                const correctAnswer = document.createElement("span");
                correctAnswer.textContent = ` (${r√©ponsesCorrectes[index]})`;
                correctAnswer.style.color = "blue"; 
                correctAnswer.style.fontWeight = "bold";
    
                // V√©rifier si la bonne r√©ponse n'est pas d√©j√† affich√©e
                if (!input.nextElementSibling || input.nextElementSibling.tagName !== "SPAN") {
                    input.parentNode.insertBefore(correctAnswer, input.nextSibling);
                }
            }
        });
    
        // Afficher le feedback g√©n√©ral
        const feedback = document.getElementById(`compl√©tion-feedback-${jeuId}`);
        if (toutesCorrectes) {
            feedback.textContent = "‚úÖ Bravo ! Vous avez correctement compl√©t√© le dialogue.";
            feedback.className = "feedback correct";
        } else {
            feedback.textContent = "‚ùå Certaines r√©ponses sont incorrectes. Les bonnes r√©ponses sont en bleu.";
            feedback.className = "feedback incorrect";
        }
    }
    
</script>

<script>
    function terminerLecon() {
        alert("F√©licitations ! Vous avez termin√© cette le√ßon.");
        // Optionnel : Rediriger vers une autre page
        window.location.href = "{% url 'detail' cours.slug %}";
    }
</script>

</body>
</html>